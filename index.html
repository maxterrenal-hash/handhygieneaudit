<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hand Hygiene Audit</title>
<style>
  :root {
    --bg: #0b0f17;
    --card: #141a24;
    --muted: #9aa7b4;
    --text: #e6edf3;
    --accent: #6ee7ff;
    --danger: #ff6b6b;
    --success: #3ad29f;
    --warning: #ffd166;
    --border: #243244;
    --input: #0e1520;
    --overlay: rgba(0,0,0,0.6);
  }
  html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  .container { max-width: 760px; margin: 0 auto; padding: 16px; }
  .h1 { font-size: 20px; font-weight: 700; margin: 8px 0 16px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin: 12px 0; overflow: hidden; }
  .row { display: flex; gap: 12px; }
  .col { flex: 1 1 0; min-width: 0; }
  label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
  select, input[type="text"], input[type="date"], input[type="number"], textarea, input[type="hidden"], .date-display {
    width: 100%; max-width: 100%; display: block; background: var(--input); color: var(--text); border: 1px solid var(--border);
    padding: 10px 12px; border-radius: 12px; outline: none; font-size: 14px;
  }
  select:focus, input:focus, textarea:focus { border-color: var(--accent); }

  .summary { display:grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
  .kpi { background: rgba(255,255,255,0.03); border:1px solid var(--border); border-radius: 12px; padding:10px; text-align:center; }
  .kpi .v { font-size: 18px; font-weight: 700; }
  .kpi .l { font-size: 12px; color: var(--muted); }

  .btn { width:auto; padding:14px 16px; border-radius: 14px; background: linear-gradient(180deg, #18a1f0, #0f7cd6); border: none; color: white; font-weight: 700; font-size: 16px; letter-spacing: 0.3px; cursor: pointer; }
  .btn.block { width:100%; }
  .btn:disabled { opacity: 0.6; cursor: not-allowed; }

  .note { color: var(--muted); font-size: 12px; margin-top: 6px; }

  @media (max-width: 480px) {
    .row { flex-direction: column; }
    .summary { grid-template-columns: repeat(2, 1fr); }
    .row.header { flex-direction: row !important; }
  }

  /* iOS-style date picker modal */
  .modal { position: fixed; inset: 0; background: var(--overlay); display: none; align-items: flex-end; justify-content: center; z-index: 999; }
  .modal.open { display: flex; }
  .sheet { width: 100%; max-width: 760px; background: var(--card); border-top-left-radius: 16px; border-top-right-radius: 16px; border: 1px solid var(--border); box-shadow: 0 -10px 30px rgba(0,0,0,0.3); }
  .sheet-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border); }
  .sheet-title { font-weight: 700; }
  .sheet-actions button { background: transparent; border: none; color: var(--accent); font-weight: 700; font-size: 14px; padding: 6px 10px; cursor: pointer; }
  .wheels { display:flex; gap: 8px; padding: 12px; height: 180px; }
  .wheel { flex: 1; position: relative; overflow-y: auto; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; border: 1px solid var(--border); border-radius: 12px; background: var(--input); }
  .wheel::-webkit-scrollbar { width: 0; height: 0; }
  .wheel-item { scroll-snap-align: center; text-align: center; padding: 10px 0; font-size: 16px; color: var(--text); }
  .wheel-spacer { height: 70px; }
  .wheel-highlight { position: absolute; left: 8px; right: 8px; top: 50%; height: 36px; margin-top: -18px; border: 1px solid var(--accent); border-radius: 8px; pointer-events: none; }
  .date-display { background: var(--input); border: 1px solid var(--border); padding: 10px 12px; border-radius: 12px; cursor: pointer; }

  /* Layout fixes */
  *, *::before, *::after { box-sizing: border-box; }

  /* Moments tally: single row, no horizontal scroll */
  #momentsTally { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 8px; overflow: hidden; }
  #momentsTally .kpi { min-width: 0; }
  #momentsTally .kpi .l { white-space: normal; overflow: hidden; text-overflow: ellipsis; }

  /* Horizontal pill rows for choices */
  .pill-row { display:flex; flex-wrap: nowrap; gap:8px; overflow-x:auto; -webkit-overflow-scrolling: touch; padding-bottom: 2px; }
  .pill-row::-webkit-scrollbar { display:none; }
  /* Moments row: fit width, no horizontal scroll */
  .pill-row.moments { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow: hidden; }
  .pill-row.moments .tile { width: 100%; min-width: 0; max-width: none; text-align: center; white-space: normal; overflow: visible; }
  .tile[aria-selected="true"] { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(110,231,255,0.18) inset; }
  .tile[disabled] { opacity:.5; cursor:not-allowed; }
  /* Actions row: no horizontal scroll on mobile */
  .pill-row.actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; overflow: hidden; }
  .pill-row.actions .tile { width: 100%; min-width: 0; max-width: none; text-align: center; white-space: normal; overflow: visible; }
  .pill-row.moments .tile { width: 100%; min-width: 0; max-width: none; text-align: center; }

  /* Clickable pill */
  .tile { flex:0 0 auto; background: rgba(255,255,255,0.03); border:1px solid var(--border); color: var(--text); padding:8px 12px; border-radius:999px; font-size:13px; cursor:pointer; outline:none; white-space:normal; line-height:1.2; max-width:220px; min-width:120px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
  .tile[aria-selected="true"] { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(110,231,255,0.18) inset; }
  .tile[disabled] { opacity:.5; cursor:not-allowed; }

  /* Opportunity card separation */
  .opp { background: rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:16px; padding:12px; margin-top:12px; }
  .opp + .opp { margin-top:12px; }
  .opp-title { font-weight:700; font-size:14px; color: var(--accent); margin-bottom:8px; }

  /* Summary chips */
  .pill-grid { display:flex; flex-wrap: wrap; gap:8px; }
  .chip { background: rgba(255,255,255,0.03); border:1px solid var(--border); color: var(--text); padding:8px 12px; border-radius:999px; font-size:13px; font-weight:700; }
  .chip.ok { border-color: #2bb673; }
  .chip.warn { border-color: #ffb703; }
  .chip.bad { border-color: #ff6b6b; }
</style>
</head>
<body>
  <div class="container">
    <div class="row header" style="align-items:center; justify-content:space-between; gap:8px;">
      <div class="h1" style="margin:0;">Hand Hygiene Audit</div>
      <button class="btn" id="summaryBtn" style="flex:0 0 auto; width:auto; padding:10px 14px; font-size:14px;">Data Summary</button>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Auditor</label>
          <select id="auditor"></select>
        </div>
        <div class="col">
          <label>Area</label>
          <select id="area"></select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Date</label>
          <!-- Hidden ISO date used for submit; visible field opens iOS-style picker -->
          <input type="hidden" id="date">
          <div id="dateDisplay" class="date-display" role="button" aria-haspopup="dialog" aria-controls="dateModal">Tap to select date</div>
        </div>
        <div class="col">
          <label>Shift</label>
          <select id="shift"></select>
        </div>
      </div>

      <div class="row" id="areaOtherRow" style="display:none;">
        <div class="col">
          <label>Specify Area (if Others)</label>
          <input type="text" id="areaOther" placeholder="Type area name">
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Form Remarks</label>
          <textarea id="formRemarks" rows="2" placeholder="General notes for this audit form"></textarea>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Auditee</label>
          <select id="auditee">
            <option value="Nurse">Nurse</option>
            <option value="Doctor">Doctor</option>
            <option value="Med Tech">Med Tech</option>
            <option value="Rad Tech">Rad Tech</option>
            <option value="Nursing Aide">Nursing Aide</option>
            <option value="Medical Intern">Medical Intern</option>
            <option value="RT">RT</option>
          </select>
        </div>
        <div class="col">
          <label>Name (Optional)</label>
          <input type="text" id="name" placeholder="Full name (optional)">
        </div>
      </div>
    </div>

    <div id="opportunities" class="card">
      <div style="font-weight:700; margin-bottom:8px;">Opportunities</div>
      <div class="note">Fill only the opportunities you observed. Blank ones are skipped when saving.</div>
    </div>

    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Compliance Tally</div>
      <div class="summary">
        <div class="kpi"><div class="v" id="k_total">0</div><div class="l">Total Filled</div></div>
        <div class="kpi"><div class="v" id="k_comp">0</div><div class="l">Compliant</div></div>
        <div class="kpi"><div class="v" id="k_miss">0</div><div class="l">Missed</div></div>
        <div class="kpi"><div class="v" id="k_rate">0%</div><div class="l">Compliance</div></div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Moments Tally</div>
      <div class="summary" id="momentsTally">
        <div class="kpi"><div class="v" id="k_m_BEF_PAT">0</div><div class="l">BEF-PAT</div></div>
        <div class="kpi"><div class="v" id="k_m_BEF_ASEPT">0</div><div class="l">BEF-ASEPT</div></div>
        <div class="kpi"><div class="v" id="k_m_AFT_BF">0</div><div class="l">AFT-BF</div></div>
        <div class="kpi"><div class="v" id="k_m_AFT_PAT">0</div><div class="l">AFT-PAT</div></div>
        <div class="kpi"><div class="v" id="k_m_AFT_PSUR">0</div><div class="l">AFT-PSUR</div></div>
      </div>
    </div>

    <div class="card">
      <button class="btn block" id="submitBtn">Submit</button>
      <div class="note"><a href="https://docs.google.com/spreadsheets/d/17gato20KLR_8T9SSVSwqLlRKvt5fX_cew_UiwyjQogo/edit?usp=sharing" target="_blank" rel="noopener">See Sheet: https://docs.google.com/spreadsheets/d/17gato20KLR_8T9SSVSwqLlRKvt5fX_cew_UiwyjQogo/edit?usp=sharing</a></div>
      <div class="note" id="status"></div>
    </div>
  </div>

  <!-- Data Summary Tab (hidden by default) -->
  <div class="container" id="tab_summary" style="display:none;">
    <div class="row header" style="align-items:center; justify-content:space-between; gap:8px;">
      <div class="h1" style="margin:0;">Data Summary</div>
      <button class="btn" id="backBtn" style="flex:0 0 auto; width:auto; padding:10px 14px; font-size:14px;">Back</button>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>Year</label>
          <select id="sum_year"></select>
        </div>
        <div class="col">
          <label>Month</label>
          <select id="sum_month"></select>
        </div>
      </div>
      <div class="note" id="summaryStatus"></div>
    </div>

    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Compliance by Area</div>
      <div class="note">Filtered by Year/Month above.</div>
      <div id="tbl_area"></div>
    </div>
  </div>

  <!-- iOS-style Date Picker Modal -->
  <div id="dateModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dateTitle">
    <div class="sheet">
      <div class="sheet-header">
        <button type="button" id="dateCancel">Cancel</button>
        <div class="sheet-title" id="dateTitle">Select Date</div>
        <button type="button" id="dateDone">Done</button>
      </div>
      <div class="wheels">
        <div class="wheel" id="wheelMonth"><div class="wheel-spacer"></div></div>
        <div class="wheel" id="wheelDay"><div class="wheel-spacer"></div></div>
        <div class="wheel" id="wheelYear"><div class="wheel-spacer"></div></div>
        <div class="wheel-highlight"></div>
      </div>
    </div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbze3tIAAebpW5r_nz7tMcL4dpdXURj4-1hgV4PNkKJi4-ZJItfXnBXrMUwPLO22dl3d/exec';

const MOMENTS = ['BEF-PAT','BEF-ASEPT','AFT-BF','AFT-PAT','AFT-PSUR'];
const ACTIONS = ['HW', 'HR', 'Missed'];
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

const state = { config: { auditors: [], areas: [], shifts: [] } };

function el(id) { return document.getElementById(id); }

async function loadConfig() {
  const defaults = {
    auditors: ['Max','Micha','Miko','Belle','Michael'],
    areas: ['7th Floor','ERC','ACM','OBGyne Ward','NICU','ICU','Surgery Ward','Dengue Ward','Infectious Ward','Medicine Ward','6th Floor Ward','Oncology Ward','Pedia Main','4th Floor Ward','Others'],
    shifts: ['6-2','2-10','10-6']
  };
  try {
    const res = await fetch(`${WEB_APP_URL}?path=config`, { method: 'GET' });
    const json = await res.json();

    const auditors = (json && Array.isArray(json.auditors) && json.auditors.length) ? json.auditors : defaults.auditors;
    const areas    = (json && Array.isArray(json.areas)    && json.areas.length)    ? json.areas    : defaults.areas;
    const shifts   = (json && Array.isArray(json.shifts)   && json.shifts.length)   ? json.shifts   : defaults.shifts;

    state.config = { auditors, areas, shifts };

    fillSelect(el('auditor'), auditors);
    fillSelect(el('shift'), shifts);
    const areasSel = el('area');
    fillSelect(areasSel, areas);
    areasSel.addEventListener('change', () => {
      const isOthers = areasSel.value === 'Others';
      el('areaOtherRow').style.display = isOthers ? '' : 'none';
    });

    setDateToToday();

    renderOpportunities();
    updateSummary();
    runSelfTests('after-config');
  } catch (e) {
    fillSelect(el('auditor'), defaults.auditors);
    fillSelect(el('shift'), defaults.shifts);
    const areasSel = el('area');
    fillSelect(areasSel, defaults.areas);
    areasSel.addEventListener('change', () => {
      const isOthers = areasSel.value === 'Others';
      el('areaOtherRow').style.display = isOthers ? '' : 'none';
    });

    setDateToToday();

    renderOpportunities();
    updateSummary();
    el('status').textContent = 'Loaded fallback lists. Check your Apps Script web app access and Config sheet headers.';
    runSelfTests('fallback');
  }
}

function fillSelect(node, items) {
  node.innerHTML = '';
  (items || []).forEach(v => { const opt = document.createElement('option'); opt.value = v; opt.textContent = v; node.appendChild(opt); });
}

function renderOpportunities() {
  const wrap = document.getElementById('opportunities');
  if (wrap.querySelector('.opp')) return;
  for (let i = 1; i <= 10; i++) {
    const opp = document.createElement('div');
    opp.className = 'opp';
    opp.dataset.opp = String(i);
    opp.innerHTML = `
      <div class="opp-title">Opportunity ${i}</div>
      <label>Moment</label>
      <div class="pill-row moments" id="mrow_${i}">
        ${MOMENTS.map(m => `<button type=\"button\" class=\"tile\" data-group=\"moment_${i}\" data-value=\"${m}\">${m}</button>`).join('')}
      </div>
      <label style="margin-top:8px;">Action</label>
      <div class="pill-row actions" id="arow_${i}">
        ${ACTIONS.map(a => `<button type=\"button\" class=\"tile\" data-group=\"action_${i}\" data-value=\"${a}\">${a}</button>`).join('')}
        <button type="button" class="tile" id="gloves_${i}" data-toggle="gloves" aria-selected="false" disabled>Gloves</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label>Time (seconds)</label>
          <input type="number" id="time_${i}" min="0" max="60" placeholder="0–60" disabled>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label>Remarks for Opportunity ${i}</label>
          <input type="text" id="oremarks_${i}" placeholder="Optional">
        </div>
      </div>`;
    wrap.appendChild(opp);

    // Moments single-select
    opp.querySelectorAll(`#mrow_${i} .tile`).forEach(btn => {
      btn.addEventListener('click', () => { selectTile(btn.dataset.group, btn.dataset.value); updateSummary(); });
    });

    // Actions single-select + gloves/time logic
    opp.querySelectorAll(`#arow_${i} .tile[data-group="action_${i}"]`).forEach(btn => {
      btn.addEventListener('click', () => {
        selectTile(btn.dataset.group, btn.dataset.value);
        const val = getSelectedValue(`action_${i}`);
        const time = el(`time_${i}`);
        const gloves = el(`gloves_${i}`);
        if (val === 'HW' || val === 'HR') {
          time.disabled = false;
          gloves.setAttribute('aria-selected','false');
          gloves.disabled = true;
        } else if (val === 'Missed') {
          time.value = '';
          time.disabled = true;
          gloves.disabled = false;
        } else {
          time.value = '';
          time.disabled = true;
          gloves.setAttribute('aria-selected','false');
          gloves.disabled = true;
        }
        updateSummary();
      });
    });

    // Gloves toggle
    opp.querySelector(`#gloves_${i}`).addEventListener('click', (e) => {
      const btn = e.currentTarget; if (btn.disabled) return;
      const curr = btn.getAttribute('aria-selected') === 'true';
      btn.setAttribute('aria-selected', curr ? 'false' : 'true');
      updateSummary();
    });

    el(`time_${i}`).addEventListener('input', updateSummary);
  }
}

function getSelectedValue(group) {
  const sel = document.querySelector(`.tile[data-group="${group}"][aria-selected="true"]`);
  return sel ? sel.dataset.value : '';
}
function selectTile(group, value) {
  document.querySelectorAll(`.tile[data-group="${group}"]`).forEach(b => b.setAttribute('aria-selected','false'));
  const target = document.querySelector(`.tile[data-group="${group}"][data-value="${CSS.escape(value)}"]`);
  if (target) target.setAttribute('aria-selected','true');
}

function collectOpportunity(i) {
  const moment = getSelectedValue(`moment_${i}`);
  const action = getSelectedValue(`action_${i}`);
  const timeInp = el(`time_${i}`);
  const timeVal = timeInp.disabled ? '' : timeInp.value;
  const gloves = (el(`gloves_${i}`).getAttribute('aria-selected') === 'true');
  const opportunityRemarks = el(`oremarks_${i}`).value.trim();

  // Skip entirely if nothing filled for this opportunity
  const hasAny = moment || action || timeVal || gloves || opportunityRemarks;
  if (!hasAny) return null;

  // Time is OPTIONAL now. If provided, validate 0–60.
  if (timeVal !== '') {
    const n = Number(timeVal);
    if (Number.isNaN(n) || n < 0 || n > 60) {
      throw new Error(`Opportunity ${i}: time must be between 0 and 60 seconds.`);
    }
  }

  // Gloves constraint stays: only with Missed
  if (gloves && action !== 'Missed') {
    throw new Error(`Opportunity ${i}: Gloves can only be checked when Action is Missed.`);
  }

  return {
    number: i,
    moment,
    action,
    timeSeconds: (timeVal === '' ? '' : Number(timeVal)),
    gloves: (action === 'Missed') ? Boolean(gloves) : false,
    opportunityRemarks
  };
}

function updateSummary() {
  let total = 0, compliantCount = 0, miss = 0;
  const mCounts = {
    'BEF-PAT': 0,
    'BEF-ASEPT': 0,
    'AFT-BF': 0,
    'AFT-PAT': 0,
    'AFT-PSUR': 0
  };
  for (let i = 1; i <= 10; i++) {
    const action = getSelectedValue(`action_${i}`);
    const moment = getSelectedValue(`moment_${i}`);
    const time = el(`time_${i}`);
    const gloves = el(`gloves_${i}`);
    const any = action || moment || (!time.disabled && time.value) || (!gloves.disabled && gloves.getAttribute('aria-selected') === 'true') || el(`oremarks_${i}`).value.trim();
    if (!any) continue;
    total++;
    if (action === 'HW' || action === 'HR') compliantCount++;
    if (action === 'Missed') miss++;
    if (moment && mCounts.hasOwnProperty(moment)) mCounts[moment]++;
  }
  const rate = total ? Math.round((compliantCount / total) * 100) : 0;
  el('k_total').textContent = String(total);
  el('k_comp').textContent = String(compliantCount);
  el('k_miss').textContent = String(miss);
  el('k_rate').textContent = `${rate}%`;
  const set = (id, v) => { const n = document.getElementById(id); if (n) n.textContent = String(v); };
  set('k_m_BEF_PAT', mCounts['BEF-PAT']);
  set('k_m_BEF_ASEPT', mCounts['BEF-ASEPT']);
  set('k_m_AFT_BF', mCounts['AFT-BF']);
  set('k_m_AFT_PAT', mCounts['AFT-PAT']);
  set('k_m_AFT_PSUR', mCounts['AFT-PSUR']);
}

function validateHeader() {
  const auditor = el('auditor').value;
  const date = el('date').value;
  const shift = el('shift').value;
  const area = el('area').value;
  const auditee = el('auditee').value;
  const missing = []; if (!auditor) missing.push('Auditor'); if (!date) missing.push('Date'); if (!shift) missing.push('Shift'); if (!area) missing.push('Area'); if (!auditee) missing.push('Auditee');
  if (missing.length) throw new Error('Missing: ' + missing.join(', '));
  let any = false; for (let i = 1; i <= 10; i++) { const op = collectOpportunity(i); if (op) { any = true; break; } } if (!any) throw new Error('Fill at least one opportunity.');
}

function gatherPayload() {
  const auditor = el('auditor').value;
  const date = el('date').value; // ISO date from hidden input
  const shift = el('shift').value;
  const area = el('area').value;
  const areaOther = (area === 'Others') ? el('areaOther').value.trim() : '';
  const auditee = el('auditee').value;
  const name = el('name').value.trim();
  const formRemarks = el('formRemarks').value.trim();
  const opportunities = []; for (let i = 1; i <= 10; i++) { const op = collectOpportunity(i); if (op) opportunities.push(op); }
  return { auditor, date, shift, area, areaOther, auditee, name, formRemarks, opportunities, userAgent: navigator.userAgent };
}

async function submitForm() {
  const btn = el('submitBtn');
  const status = el('status');
  status.textContent = '';
  btn.disabled = true;
  try {
    validateHeader();
    const payload = gatherPayload();

    const res = await fetch(`${WEB_APP_URL}?path=submit`, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });

    const ctype = (res.headers.get('content-type') || '').toLowerCase();
    let data = null, text = '';
    if (ctype.includes('application/json')) {
      data = await res.json();
    } else {
      text = await res.text();
      try { data = JSON.parse(text); } catch (_) { /* not JSON */ }
    }

    if (!res.ok) {
      const serverMsg = (data && (data.error || data.message)) || text || res.statusText || 'Submission failed';
      throw new Error(`Server error (${res.status}): ${serverMsg}`);
    }

    const stored = (data && (data.stored ?? data.rows ?? data.count)) || '';
    status.textContent = stored ? `Saved ${stored} row(s).` : 'Saved.';
    status.style.color = 'var(--success)';

    for (let i = 1; i <= 10; i++) {
      document.querySelectorAll(`.tile[data-group="moment_${i}"], .tile[data-group="action_${i}"]`).forEach(b => b.setAttribute('aria-selected','false'));
      const g = el(`gloves_${i}`); g.setAttribute('aria-selected','false'); g.disabled = true;
      el(`time_${i}`).value = ''; el(`time_${i}`).disabled = true; el(`oremarks_${i}`).value = '';
    }
    updateSummary();
  } catch (e) {
    status.textContent = e.message || 'Load failed. Please check your Apps Script deployment.';
    status.style.color = 'var(--danger)';
    console.error('[Submit] Error:', e);
  } finally {
    btn.disabled = false;
  }
}

// iOS-style date picker logic
function setDateToToday() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const iso = `${yyyy}-${mm}-${dd}`;
  el('date').value = iso;
  el('dateDisplay').textContent = formatPrettyDate(yyyy, mm, dd);
}

function formatPrettyDate(yyyy, mm, dd) {
  const mName = MONTHS[Number(mm)-1];
  return `${mName} ${Number(dd)}, ${yyyy}`;
}

function openDatePicker() {
  const iso = el('date').value || (()=>{ setDateToToday(); return el('date').value; })();
  const [y, m, d] = iso.split('-').map(Number);
  buildWheel(el('wheelMonth'), MONTHS.map((n,i)=>({label:n, value:i+1})), m);
  buildWheel(el('wheelDay'), Array.from({length: daysInMonth(m, y)}, (_,i)=>({label:String(i+1), value:i+1})), d);
  const currentYear = new Date().getFullYear();
  const years = Array.from({length: 11}, (_,i)=> currentYear-5 + i); // currentYear-5 .. +5
  buildWheel(el('wheelYear'), years.map(v=>({label:String(v), value:v})), y);
  el('dateModal').classList.add('open');
}

function closeDatePicker() { el('dateModal').classList.remove('open'); }

function buildWheel(container, items, selectedValue) {
  container.innerHTML = '<div class="wheel-spacer"></div>';
  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 'wheel-item';
    div.textContent = it.label;
    div.dataset.value = it.value;
    container.appendChild(div);
  });
  container.appendChild(Object.assign(document.createElement('div'),{className:'wheel-spacer'}));
  const idx = Math.max(0, items.findIndex(i=> i.value === selectedValue));
  const item = container.querySelectorAll('.wheel-item')[idx];
  if (item) container.scrollTo({ top: item.offsetTop - (container.clientHeight/2 - 18), behavior: 'instant' });
  container.onscroll = debounce(()=> snapToNearest(container), 80);
}

function snapToNearest(container) {
  const items = Array.from(container.querySelectorAll('.wheel-item'));
  if (!items.length) return;
  const center = container.scrollTop + container.clientHeight/2;
  let nearest = items[0]; let minDist = Infinity;
  items.forEach(it => { const dist = Math.abs((it.offsetTop + it.offsetHeight/2) - center); if (dist < minDist) { minDist = dist; nearest = it; } });
  container.scrollTo({ top: nearest.offsetTop - (container.clientHeight/2 - nearest.offsetHeight/2), behavior: 'smooth' });
}

function daysInMonth(m, y) { return new Date(y, m, 0).getDate(); }

function getSelected(container) {
  const items = Array.from(container.querySelectorAll('.wheel-item'));
  const center = container.scrollTop + container.clientHeight/2;
  let nearest = items[0]; let minDist = Infinity;
  items.forEach(it => { const dist = Math.abs((it.offsetTop + it.offsetHeight/2) - center); if (dist < minDist) { minDist = dist; nearest = it; } });
  return Number(nearest.dataset.value);
}

function debounce(fn, wait) { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), wait); }; }

function commitDateFromWheels() {
  const m = getSelected(el('wheelMonth'));
  const y = getSelected(el('wheelYear'));
  const maxDay = daysInMonth(m, y);
  const currentDay = Math.min(getSelected(el('wheelDay')), maxDay);
  buildWheel(el('wheelDay'), Array.from({length: maxDay}, (_,i)=>({label:String(i+1), value:i+1})), currentDay);
}

function doneDatePicker() {
  const m = String(getSelected(el('wheelMonth'))).padStart(2,'0');
  const d = String(getSelected(el('wheelDay'))).padStart(2,'0');
  const y = getSelected(el('wheelYear'));
  const iso = `${y}-${m}-${d}`;
  el('date').value = iso;
  el('dateDisplay').textContent = formatPrettyDate(y, m, d);
  closeDatePicker();
}

// ===== Summary Tab logic =====
function openSummary() {
  const main = document.querySelectorAll('body > .container')[0];
  if (main) main.style.display = 'none';
  document.getElementById('tab_summary').style.display = '';
  buildSummaryFilters();
  loadSummary();
}
function backToForm() {
  document.getElementById('tab_summary').style.display = 'none';
  const main = document.querySelectorAll('body > .container')[0];
  if (main) main.style.display = '';
}

function buildSummaryFilters() {
  const ySel = document.getElementById('sum_year');
  const mSel = document.getElementById('sum_month');
  const curY = new Date().getFullYear();
  ySel.innerHTML = '';
  for (let y = 2025; y <= curY; y++) {
    const o = document.createElement('option'); o.value = String(y); o.textContent = String(y); ySel.appendChild(o);
  }
  ySel.value = String(curY);
  const months = ['All','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  mSel.innerHTML = months.map((m,i)=> `<option value="${i===0?'all':String(i).padStart(2,'0')}">${m}</option>`).join('');
  mSel.value = 'all';
  ySel.onchange = loadSummary; mSel.onchange = loadSummary;
}

async function loadSummary() {
  const year = document.getElementById('sum_year').value;
  const month = document.getElementById('sum_month').value; // 'all' or '01'..'12'
  const status = document.getElementById('summaryStatus');
  status.textContent = 'Loading...';
  try {
    const url = new URL(WEB_APP_URL);
    url.searchParams.set('path','summary');
    url.searchParams.set('year', year);
    url.searchParams.set('month', month);
    const res = await fetch(url.toString(), { method: 'GET' });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const rows = Array.isArray(data.rows) ? data.rows : [];
    const filtered = rows.filter(r => {
      const dateRaw = r.date ?? r.Date ?? r.DATE ?? r.timestamp ?? r.Timestamp ?? r.TIME ?? r.Time ?? '';
      const ym = getYM(dateRaw);
      if (!ym.y) return false;
      if (ym.y !== year) return false;
      if (month !== 'all' && ym.m !== month) return false;
      return true;
    });

    renderAreaPills(filtered);
    status.textContent = `${filtered.length} records.`;
  } catch (e) {
    console.error('[Summary] error', e);
    status.textContent = e.message || 'Failed to load summary.';
  }
}

function isCompliant(action) {
  if (!action && action !== 0) return false;
  const a = String(action).trim().toLowerCase();
  return a === 'hw' || a === 'hr' || a === 'hand wash' || a === 'hand rub';
}

function getYM(val) {
  if (!val) return { y: null, m: null };
  const tryParse = (s) => {
    const d = new Date(s);
    if (!isNaN(d)) return { y: String(d.getFullYear()), m: String(d.getMonth()+1).padStart(2,'0') };
    return null;
  };
  let s = val;
  if (typeof s !== 'string') s = String(s);
  const d0 = tryParse(s); if (d0) return d0;
  if (s.includes('-')) { const p = s.split('-'); if (p.length>=2) return { y: p[0], m: String(p[1]).padStart(2,'0') }; }
  if (s.includes('/')) { const p = s.split('/'); if (p.length>=3) return { y: p[2], m: String(p[0]).padStart(2,'0') }; }
  if (s.includes('.')) { const p = s.split('.'); if (p.length>=3) return { y: p[2], m: String(p[0]).padStart(2,'0') }; }
  return { y: null, m: null };
}

function renderAreaPills(rows) {
  const configuredAreas = (state && state.config && Array.isArray(state.config.areas) && state.config.areas.length)
    ? state.config.areas
    : Array.from(new Set(rows.map(r => (r.area ?? r.Area ?? r.ward ?? r.Ward ?? 'Unknown'))));

  const items = configuredAreas.map(areaName => {
    const subset = rows.filter(r => (r.area ?? r.Area ?? r.ward ?? r.Ward ?? 'Unknown') === areaName);
    const total = subset.length;
    const compliantCount = subset.filter(r => isCompliant(r.action ?? r.Action ?? r.ACTION)).length;
    const rate = total ? Math.round((compliantCount * 100) / total) : 0;
    return { area: areaName, compliantCount, total, rate };
  });

  items.sort((a,b)=> a.area.localeCompare(b.area));

  const wrap = document.createElement('div');
  wrap.className = 'pill-grid';
  items.forEach(x => {
    const chip = document.createElement('div');
    chip.className = 'chip ' + (x.rate >= 80 ? 'ok' : x.rate >= 50 ? 'warn' : 'bad');
    chip.textContent = `${x.area} — ${x.rate}%`;
    wrap.appendChild(chip);
  });
  const host = document.getElementById('tbl_area');
  host.innerHTML = '';
  host.appendChild(wrap);
}

// Wire header buttons
  document.getElementById('summaryBtn')?.addEventListener('click', openSummary);
  document.getElementById('backBtn')?.addEventListener('click', backToForm);

// Initial boot
loadConfig();

// Enable in-wheel recompute
['wheelMonth','wheelYear'].forEach(id=>{
  el(id).addEventListener('scroll', debounce(commitDateFromWheels, 120));
});

document.addEventListener('click', (e)=>{
  if (e.target.id === 'dateDisplay') openDatePicker();
});

el('dateCancel')?.addEventListener('click', closeDatePicker);

el('dateDone')?.addEventListener('click', doneDatePicker);

// Submit
if (document.getElementById('submitBtn')) { document.getElementById('submitBtn').addEventListener('click', submitForm); }

// ===== Self/Unit Tests =====
function runSelfTests(mode) {
  try {
    const opps = document.querySelectorAll('#opportunities .opp');
    console.assert(opps.length === 10, `Expected 10 opportunities, found ${opps.length}`);
    console.assert(el('auditor').options.length > 0, 'Auditor dropdown should not be empty');
    console.assert(el('area').options.length > 0, 'Area dropdown should not be empty');
    console.assert(el('shift').options.length > 0, 'Shift dropdown should not be empty');
    console.assert(el('date').value.length === 10, 'Hidden ISO date should be set');
    console.assert(!!document.getElementById('summaryBtn'), 'Summary button must exist');
    console.assert(!!document.getElementById('backBtn'), 'Back button must exist in summary tab');
    runUnitTests();
    console.log('[SelfTest]', mode, 'OK');
  } catch (err) { console.error('[SelfTest] failed:', err); }
}

function runUnitTests() {
  console.assert(getYM('2025-11-02').y === '2025' && getYM('2025-11-02').m === '11', 'ISO date parse');
  console.assert(getYM('11/02/2025').y === '2025' && getYM('11/02/2025').m === '11', 'US date parse');
  console.assert(isCompliant('HW') && isCompliant('HR'), 'isCompliant codes');
  console.assert(isCompliant('Hand Wash') && isCompliant('Hand Rub'), 'isCompliant legacy');
  console.assert(isCompliant('hand wash') && isCompliant('hr'), 'isCompliant lower-case');
}

</script>
</body>
</html>
